---
title: "Google Cloud ã§é ‘å¼µã£ã¦ãƒˆãƒ¬ãƒ¼ã‚¹ã™ã‚‹"
createdAt: "2024/12/31"
heroIcon: "ğŸ¾"
tags: ["Google Cloud", "CloudRun", "OpenTelemetry"]
---

# TL;DR

- ãƒˆãƒ¬ãƒ¼ã‚¹ã™ã‚‹éš›ã¯ã‚¢ãƒ—ãƒªé–“ã§ traceparent ã‚’å—ã‘æ¸¡ã™
- CloudRun ã‚’ä½¿ã†éš›ã¯æ¨™æº–åŒ–ã•ã‚Œã¦ã„ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼ã§ãªãç‹¬è‡ªãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ã†ã¨è‰¯ã„

# å‰æ
- Google Cloud ç’°å¢ƒã§ goã§ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã®ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ã™ã‚‹

# åŸºç¤çŸ¥è­˜

## OpenTelemetry ã¨ã¯

- åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã‚„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚„å‹•ä½œã‚’è¦³æ¸¬ã™ã‚‹ãŸã‚ã®ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®ãƒ„ãƒ¼ãƒ«ã‚­ãƒƒãƒˆã§ã™ã€‚
- ãƒ­ã‚°ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã€ãƒˆãƒ¬ãƒ¼ã‚¹ã¨ã„ã£ãŸè¦³æ¸¬ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã€å‡¦ç†ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã®æ¨™æº–åŒ–ã•ã‚ŒãŸãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æä¾›ã—ã¾ã™ã€‚
- ãƒ‡ãƒ¼ã‚¿é€ä¿¡å…ˆã¯ AWS X-Rayã€DataDogã€Zipkin ãªã©ãŒã‚ã‚Šã¾ã™ã€‚
- Google Cloud ã§ã¯ Trace ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ã§é–²è¦§ã§ãã¾ã™ã€‚

## ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å®Ÿç¾ã™ã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

- 1ã¤ã®ãƒˆãƒ¬ãƒ¼ã‚¹ã«å¯¾ã—ã€è¤‡æ•°ã® Span ã‚’ä¿æŒã™ã‚‹æ§‹é€ ã«ãªã£ã¦ã„ã¾ã™ã€‚
- Span ãŒæŒã¤ãƒ‡ãƒ¼ã‚¿ã¯ä¸‹è¨˜ã«ãªã‚Šã¾ã™ã€‚
```
- SpanIDï¼ˆ4e9caf3181b6960dï¼‰
- è¦ªSpanIDï¼ˆ34f5b537ec9b47d0ï¼‰
- Spané–‹å§‹æ™‚é–“ï¼ˆ2024-12-10T01:59:45.804Zï¼‰
- Spançµ‚äº†æ™‚é–“ï¼ˆ2024-12-10T02:59:45.804Zï¼‰
- TraceIDï¼ˆ2a5575cb97bf1a7df321a08666119d33ï¼‰
```
- Span ã¯è¦ªå­é–¢ä¿‚ãªã®ã§ãƒ„ãƒªãƒ¼ä¸Šã«é€£çµã§ãã¾ã™ã€‚
- ã‚³ãƒ¼ãƒ‰ä¸Šã§ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ã™ã‚‹ã ã‘ã§éšå±¤çš„ãª span ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¦ãã‚Œã¾ã™ã€‚
```go
ctx1, span1 := otel.Tracer.Start(ctx, "å‡¦ç†1")
// å‡¦ç†ä¸­1
ctx2, span2 := otel.Tracer.Start(ctx1, "å‡¦ç†2")
// å‡¦ç†ä¸­2
span2.End()
span1.End()
```

## ãƒˆãƒ¬ãƒ¼ã‚¹ã«ãƒ­ã‚°ã‚’é–¢é€£ä»˜ã‘ã‚‹ãŸã‚ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

- ä¸‹è¨˜æƒ…å ±ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã§ Trace ã¨é–¢é€£ä»˜ã‘ã¦ãã‚Œã¾ã™ã€‚

```
{
  ...
  trace: "projects/{project_id}/traces/2a5575cb97bf1a7df321a08666119d33"
  spanId: "f15607489bb19ff9"
  traceSampled: true
  ...
}
```

  - https://cloud.google.com/trace/docs/setup/go-ot?hl=ja#config-structured-logging

- ã‚³ãƒ¼ãƒ‰ä¸Šã§ã¯ãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«å«ã‚ã¦ãŠãã€ãƒ­ã‚°å‡ºåŠ›ã®éš›ã«ä¸€ç·’ã«æ¸¡ã™ã®ãŒä¸€èˆ¬çš„ãªã‚ˆã†ã§ã™ã€‚
```go
// ä¾‹
logger.InfoContext(ctx, "å‡¦ç†ä¸­")
```

## è¤‡æ•°ã‚¢ãƒ—ãƒªã§ Trace ã‚’é–¢é€£ä»˜ã‘ã‚‹ä»•çµ„ã¿

- W3C ã§ HTTP ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’åˆ©ç”¨ã—ã¦é–¢é€£ä»˜ã‘ã‚‹æ–¹æ³•ãŒè¦æ ¼åŒ–ã•ã‚Œã¦ã„ã‚‹ã®ã§ã“ã‚Œã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
  - traceparent ãƒ˜ãƒƒãƒ€ãƒ¼
    - https://www.w3.org/TR/trace-context/#examples-of-http-traceparent-headers
    - ãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’ä¿æŒã—ã¾ã™ã€‚
    - å½¢å¼ã¯`{version}-{trace-id}-{parent-id}-{trace-flags}`
      - ç¾åœ¨ã€version ã¯ 00 ã®ã¿
      - parent-id ã¯è¦ªã‚¹ãƒ‘ãƒ³ã‚’ä¸€æ„ã«è­˜åˆ¥ã™ã‚‹ ID
      - sampled-flags ã¯ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®æœ‰ç„¡ã‚’ç¤ºã—ã€ãƒˆãƒ¬ãƒ¼ã‚¹æ¯ã«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã™ã‚‹ã—ãªã„ã‚’åˆ¤æ–­ã—ã¾ã™ã€‚
    - ```traceparent: 00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01```
  - tracestate ãƒ˜ãƒƒãƒ€ãƒ¼
    - ç•°ãªã‚‹ãƒ™ãƒ³ãƒ€ãƒ¼ã‚„ã‚µãƒ¼ãƒ“ã‚¹ãŒç‹¬è‡ªã®æƒ…å ±ã‚’ä¿æŒã—ã¾ã™ã€‚
    - ```tracestate: congo=t61rcWkgMzE```
- https://qiita.com/sukatsu1222/items/82819461921deba761b9
- CloudRun ã§è©¦ã—ãŸé™ã‚Š tracestate ã¯åˆ©ç”¨ã—ã¦ãªã•ãã†ãªã®ã§ã€traceparent ã•ãˆä¼æ¬ã§ãã‚Œã°ãƒˆãƒ¬ãƒ¼ã‚¹ãŒã§ãã¾ã™ã€‚

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã©ã®ã‚ˆã†ã«å®Ÿç¾ã™ã‚‹ã‹

- åˆæœŸåŒ–å‡¦ç†ï¼ˆhttps://cloud.google.com/trace/docs/setup/go-ot?hl=ja#config-otelï¼‰
  - åŸºæœ¬ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¨­å®šï¼ˆã‚µãƒ¼ãƒ“ã‚¹åãƒ»ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ ID ãªã©ï¼‰
  - é€ä¿¡æ–¹æ³•ã®è¨­å®šï¼ˆé€æ¬¡ or ãƒãƒƒãƒã§é€ä¿¡ã™ã‚‹ï¼‰
  - ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®è¨­å®šï¼ˆåŸºæœ¬ã¯è¦ª span ã«å¾“ã†ãŒãªã‘ã‚Œã°å¸¸ã«è¨ˆæ¸¬ or å¸¸ã«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã™ã‚‹ãªã©ï¼‰
  ```
  // è¨­å®šå¯èƒ½ãªå€¤
  "always_on": AlwaysOnSampler // å¸¸ã«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã™ã‚‹
  "always_off": AlwaysOffSampler
  "traceidratio": TraceIdRatioBased
  "parentbased_always_on": ParentBased(root=AlwaysOnSampler) // traceparentãŒã‚ã‚Œã°å¾“ã„ã€ãªã‘ã‚Œã°å¸¸ã«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã™ã‚‹
  "parentbased_always_off": ParentBased(root=AlwaysOffSampler)
  "parentbased_traceidratio": ParentBased(root=TraceIdRatioBased)
  "parentbased_jaeger_remote": ParentBased(root=JaegerRemoteSampler)
  ```
    - https://opentelemetry.io/docs/specs/otel/configuration/sdk-environment-variables/
  - Golang ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã ã¨è¨­å®šå€¤ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«æŒãŸã›ã¦ã„ãã†ã§ã™ã€‚
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡æ™‚ã®å‡¦ç†ï¼ˆhttps://cloud.google.com/trace/docs/setup/go-ot?hl=ja#serverï¼‰
  - ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ traceparentã€tracestate ã‚’å–å¾—ã— Context ã«è©°ã‚ã¾ã™ã€‚
  - context ã®æƒ…å ±ã‚’åŸºã«å­ span ã‚’ä½œæˆã—ã¦ context ã‚’æ›´æ–°ã—ã¾ã™ã€‚
    - ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨­å®šãŒ parent ã¨é•ã†è¨­å®šã‚’ã—ã¦ã„ã‚‹å ´åˆã§ã‚‚ã€ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ sampled-flags ã‚’ä¸Šæ›¸ãã—ã¦ Context ã‚’æ›´æ–°ã—ã¾ã™ã€‚
      - https://github.com/open-telemetry/opentelemetry-go/blob/v1.32.0/sdk/trace/tracer.go#L87
  - ä»–ã‚¢ãƒ—ãƒªã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹éš›ã« context ã®æƒ…å ±ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«è©°ã‚ã¾ã™ã€‚

# Google Cloud ã®å„ç¨®ã‚µãƒ¼ãƒ“ã‚¹ã§ã©ã®ã‚ˆã†ã«åˆ©ç”¨ã™ã‚‹ã‹

- CloudRun ã§è©¦ã™ã¨ tracestate ã¯ç©ºã ã£ãŸã®ã§ã€traceparent ã‚’ä»–ã‚µãƒ¼ãƒ“ã‚¹ã«ä¼æ¬ã•ã›ã‚‰ã‚Œã‚Œã°è¨ˆæ¸¬ã§ãã¾ã™ã€‚
- å„ç¨®ã‚µãƒ¼ãƒ“ã‚¹
  - CloudRun
    - ãƒ˜ãƒƒãƒ€ãƒ¼ã§ traceparent ã‚’æ¸¡ã—ã¾ã™ã€‚
  - PubSub
    - Pull å‹ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã ã‘ã§æ©Ÿèƒ½ã—ãã†ã§ã™ã€‚
      - https://cloud.google.com/pubsub/docs/open-telemetry-tracing?hl=ja#considerations
    - Push å‹ã¯ä¸Šè¨˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã—ã¦ã‚‚æ©Ÿèƒ½ã—ãªã‹ã£ãŸã®ã§ã€message ã® Attribute ã« traceparent ã‚’æ¸¡ã—ã¾ã™ã€‚
      - ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ push å…ˆã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã« traceparent ãƒ˜ãƒƒãƒ€ãƒ¼ãŒä½œæˆã•ã‚Œã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¾ã—ãŸãŒã€ãã†ã„ã†æŒ™å‹•ã§ã¯ãªã•ãã†ã§ã™ã€‚
  - Workflow
    - å¼•æ•°ã‚„ç’°å¢ƒå¤‰æ•°ã§ traceparent ã‚’æ¸¡ã—ã¾ã™ã€‚

# CloudRun ã®æŒ™å‹•ã«ã‚ã‚ã›ã¦ãƒˆãƒ¬ãƒ¼ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

- CloudRun ã¯å‹•ããŒç‰¹æ®Šã ã£ãŸã®ã§ã€ãã®å•é¡Œç‚¹ã¨å¯¾å¿œã‚’åˆ—æŒ™ã—ã¦ãŠãã¾ã™ã€‚

## å•é¡Œãã®1ï¼è¨­å®šã—ãŸã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒ¬ãƒ¼ãƒˆãŒåæ˜ ã•ã‚Œãªã„

- æŒ™å‹•ç¢ºèªã™ã‚‹ãŸã‚ã« parentbased_always_on ã‚’å…¨ã¦ã®ã‚¢ãƒ—ãƒªã«è¨­å®šã—ã€ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’è©¦ã¿ã¾ã—ãŸãŒä¸€éƒ¨ã—ã‹ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚
- ã©ã†ã‚„ã‚‰ CloudRun ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ traceparent ãƒ˜ãƒƒãƒ€ãƒ¼ãŒç™ºè¡Œã•ã‚Œã¦ãŠã‚Šã€ãã‚Œã«å¾“ã£ã¦ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒ¬ãƒ¼ãƒˆãŒæ±ºã¾ã£ã¦ã—ã¾ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã—ãŸã€‚
- ã“ã® traceparent ã¯ã‚¢ãƒ—ãƒªå®Ÿè£…ã«é–¢ä¿‚ãªãã€ã‚¤ãƒ³ãƒ•ãƒ©å´ã§è‡ªå‹•çš„ã«ç™ºè¡Œã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™
- ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã¯ 10 ç§’ã”ã¨ã« 1 ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‰²åˆã«ãªã£ã¦ãŠã‚Šã€è¨­å®šã®å¤‰æ›´ã¯ã§ãã¾ã›ã‚“ã€‚
  - https://cloud.google.com/run/docs/trace?hl=ja#trace_sampling_rate

### å¯¾å¿œ

- ãƒˆãƒ¬ãƒ¼ã‚¹é–‹å§‹ã™ã‚‹ CloudRun ã§ã¯ parentbased è¨­å®šã‚’ã›ãšã«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒ¬ãƒ¼ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚
```go
// NewTracerProviderã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
trace.WithSampler(trace.AlwaysSample())
```

## å•é¡Œãã®2ï¼ãƒˆãƒƒãƒ—ã® Span ãŒæ¬ æã™ã‚‹

- ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¥‘æ©Ÿã®ãƒˆãƒ¬ãƒ¼ã‚¹ã«ãŠã„ã¦æœ€ä¸Šä½ã® Span ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

### å¯¾å¿œ

- è«¦ã‚ã¾ã—ãŸã€‚è¦‹æ „ãˆã¯æ‚ªã„ã§ã™ãŒãƒˆãƒ¬ãƒ¼ã‚¹è¦³ç‚¹ã§ã¯å•é¡Œã«ãªã‚‰ãªã„æƒ³å®šã§ã™ã€‚

## å•é¡Œãã®3ï¼ã‚¢ãƒ—ãƒªã‚’è·¨ã„ã æ™‚ã« Span ãŒæ¬ è½ã—ã€éšå±¤æ§‹é€ ãŒå´©ã‚Œã‚‹

- è¦ªã‚¢ãƒ—ãƒªã‹ã‚‰å­ã‚¢ãƒ—ãƒªã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãŸéš›ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è¦ª Span ãŒãªã„çŠ¶æ…‹ã§ãƒˆãƒ¬ãƒ¼ã‚¹ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
- å‹•ãã¨ã—ã¦ã¯ã€å­ã‚¢ãƒ—ãƒªãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡æ™‚ã«è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã‚‹ï¼ˆã‚¢ãƒ—ãƒªã®å®Ÿè£…é–¢ä¿‚ãªãã‚¤ãƒ³ãƒ•ãƒ©ãŒè‡ªå‹•ç™ºè¡Œã™ã‚‹ï¼‰ Span ãŒã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã•ã‚Œãªã„æ™‚ãŒã‚ã‚Šãã†ã§ã™ã€‚
  - ã¤ã¾ã‚Šã€å­ã‚¢ãƒ—ãƒªãŒå—ã‘å–ã‚‹ traceparent ãƒ˜ãƒƒãƒ€ãƒ¼ã«å«ã¾ã‚Œã‚‹ parent-idï¼ˆè¦ª spanIDï¼‰ãŒãƒˆãƒ¬ãƒ¼ã‚¹å´ã§ç¢ºèªã§ããªã„ãŸã‚ã«éšå±¤æ§‹é€ ãŒå´©ã‚Œã¾ã™ã€‚
  - æœ¬æ¥ãªã‚‰ traceparent ãƒ˜ãƒƒãƒ€ãƒ¼ã® trace-flag ã«åŸºã¥ã„ã¦ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã¹ããªã®ã ãŒã€ãã†ãªã£ã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚
    - trace-flag ã¯ãƒ’ãƒ³ãƒˆã«ã¯åˆ©ç”¨ã™ã‚‹ãŒéµå®ˆã™ã‚‹ã‚ã‘ã§ã¯ãªã•ãã†ã§ã™
      - https://cloud.google.com/trace/docs/setup?hl=ja#force-trace
    - æã‚‰ã CloudRun ãŒè‡ªå‹•çš„ã«ç™ºè¡Œã™ã‚‹ Span ã¯ç„¡æ–™ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ä¸€å®šåˆ¶é™ã‚’æ›ã‘ã¦ã„ã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚

### å¯¾å¿œ

- traceparent ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã¯ç•°ãªã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼ã§ traceparent ã®å—ã‘æ¸¡ã—ã‚’ã—ã¾ã™ã€‚
- åˆæœŸåŒ–å‡¦ç†ã«ã¤ã„ã¦ã€`NewTextMapPropagator`ã®å®Ÿè£…ã‚’ã¿ã‚‹ã¨ã€ãƒˆãƒ¬ãƒ¼ã‚¹ã™ã‚‹ã ã‘ãªã‚‰ä¸‹è¨˜ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```go
- otel.SetTextMapPropagator(autoprop.NewTextMapPropagator())
+ otel.SetTextMapPropagator(propagation.TraceContext{})
```
- ãã—ã¦ã€TraceContext ã®å®Ÿè£…ã‚’ã¿ã‚‹ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆcarrierï¼‰ã‚’å¯¾è±¡ã« traceparent ã¨ tracestate ã‚’ Set ã‚„ Get ã—ã¦ã„ã‚‹ã ã‘ã¨åˆ†ã‹ã‚Šã¾ã™ã€‚
  - https://github.com/open-telemetry/opentelemetry-go/blob/v1.33.0/propagation/trace_context.go#L31
- ã‚ˆã£ã¦ã€ä¸‹è¨˜ã®ã‚ˆã†ãª Wrapper ã‚’å·®ã—è¾¼ã‚ã°ç‹¬è‡ªã®ãƒ˜ãƒƒãƒ€ãƒ¼ã§å—ã‘æ¸¡ã—ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```go
// åˆæœŸåŒ–å‡¦ç†
- otel.SetTextMapPropagator(propagation.TraceContext{})
+ otel.SetTextMapPropagator(WrapTraceContext{})

// Wrapperã®å®šç¾©
type WrapTraceContext struct {
  propagation.TraceContext
}

func (w WrapTraceContext) Inject(ctx context.Context, carrier propagation.TextMapCarrier) {
  w.TraceContext.Inject(ctx, WrapTextMapCarrier{carrier})
}

func (w WrapTraceContext) Extract(ctx context.Context, carrier propagation.TextMapCarrier) context.Context {
  return w.TraceContext.Extract(ctx, WrapTextMapCarrier{carrier})
}

type WrapTextMapCarrier struct {
  propagation.TextMapCarrier
}

const customHeaderPrefix = "custom-"

func (w WrapTextMapCarrier) Set(key, value string) {
  // traceparentã¨tracestateã«ãŠã„ã¦ã€ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã‚«ã‚¹ã‚¿ãƒ ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸¡æ–¹ã«å€¤ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
  w.TextMapCarrier.Set(key, value)
  w.TextMapCarrier.Set(customHeaderPrefix+key, value)
}

func (w WrapTextMapCarrier) Get(key string) string {
  // traceparentã¨tracestateã«ãŠã„ã¦ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å„ªå…ˆã—ã¦å–å¾—ã™ã‚‹
  customHeaderVal := w.TextMapCarrier.Get(customHeaderPrefix + key)
  if customHeaderVal != "" {
    return customHeaderVal
  }
  return w.TextMapCarrier.Get(key)
}
  ```

# å‚è€ƒ

- https://dev.henry.jp/entry/cloud-native-opentelemetry
- https://christina04.hatenablog.com/entry/distributed-tracing-with-opentelemetry
- https://zenn.dev/mongamae_nioh/articles/4df1950420423b
- https://qiita.com/atsu_kg/items/c3ee8141e4638957a947
- https://zenn.dev/hkdord/articles/opentelemetry-sdk-deep-dive
- https://christina04.hatenablog.com/entry/opentelemetry-in-go
- https://zenn.dev/vaxila_labs/articles/a91f3a2af2f365
- https://github.com/GoogleCloudPlatform/opentelemetry-cloud-run/issues/18
