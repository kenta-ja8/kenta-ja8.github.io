---
title: "ãŠã†ã¡k8sæ§‹ç¯‰æ‰‹é †ãƒ¡ãƒ¢"
description: "ãƒ©ã‚ºãƒ™ãƒªãƒ¼ãƒ‘ã‚¤ã‚’ä½¿ç”¨ã—ãŸãƒ›ãƒ¼ãƒ  Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®æ§‹ç¯‰æ‰‹é †ã€‚IPå›ºå®šã€cgroupè¨­å®šã€kubeadm ã«ã‚ˆã‚‹ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ§‹ç¯‰ã¾ã§ã®æ‰‹é †ã‚’è¨˜éŒ²ã€‚"
createdAt: "2024/10/26"
heroIcon: "ğŸ "
tags: ["k8s"]
---

# TL;DR

- ãƒ©ã‚ºãƒ‘ã‚¤ã‚’ä½¿ã£ã¦ãŠã†ã¡ k8s ã‚’æ§‹ç¯‰ã—ãŸéš›ã®æ‰‹é †ãƒ¡ãƒ¢
  - [GitHub ã§ç®¡ç†ã—ã¦ã„ã‚‹ Manifest](https://github.com/kenta-ja8/home-k8s.git)

# ç’°å¢ƒ

- ãƒã‚¹ã‚¿ãƒ¼ï¼š ãƒ©ã‚ºãƒ™ãƒªãƒ¼ãƒ‘ã‚¤ï¼” Ã— 1
- ãƒ¯ãƒ¼ã‚«ãƒ¼ï¼š ãƒ©ã‚ºãƒ™ãƒªãƒ¼ãƒ‘ã‚¤ï¼• Ã— 1

# æ‰‹é †ãƒ¡ãƒ¢

## IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å›ºå®š

```sh
sudo nmcli connection modify 'Wired connection 1' ipv4.method manual ipv4.addresses 192.168.0.10/24 ipv4.gateway 192.168.0.1 ipv4.dns 1.1.1.1
sudo nmcli device disconnect "Wired connection 1" && sudo nmcli device connect "Wired connection 1"
sudo nmcli device disconnect eth0 && sudo nmcli device connect eth0
```

## cgroup ã§ãƒ¡ãƒ¢ãƒªã®æœ‰åŠ¹åŒ–

- RaspberryOS ã®ã‚ˆã†ãªã€ã‚¨ãƒƒã‚¸ç”¨ OS ã ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå¤šã„ã‚‰ã—ã„

```sh
vim /boot/firmware/cmdline.txt
Change -> cgroup_memory=1 cgroup_enable=memory
cat /proc/cgroups
```

## ã‚¹ãƒ¯ãƒƒãƒ—ç„¡åŠ¹åŒ–

- k8s ã§ã¯ã‚¹ãƒ¯ãƒƒãƒ—ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

```sh
sudo swapoff --all
sudo systemctl stop dphys-swapfile
sudo systemctl disable dphys-swapfile
systemctl status dphys-swapfile
```

## ip ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æœ‰åŠ¹åŒ–

```sh
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.ipv4.ip_forward = 1
EOF

sudo sysctl --system
```

## containerd.io ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

- https://matsuand.github.io/docs.docker.jp.onthefly/engine/install/debian/

```sh
sudo apt-get install \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

echo "deb [signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian \
$(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

cat /etc/apt/sources.list.d/docker.list
sudo apt-get install containerd.io
```

## kubelet kubeadm kubectl ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```sh
sudo apt-get install -y apt-transport-https ca-certificates curl gpg

curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
sudo systemctl enable --now kubelet
```

## Kubelet ãŒ systemd ã‚’ cgroup ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã‚ˆã†è¨­å®š

```sh
vim /etc/default/kubelet
KUBELET_EXTRA_ARGS=--cgroup-driver=systemd

systemctl daemon-reload
systemctl restart kubelet
```

## Containerd ãŒ systemd ã‚’ cgroup ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã‚ˆã†è¨­å®š

```sh
containerd config default | sudo tee /etc/containerd/config.toml

vim /etc/containerd/config.toml
Change -> SystemdCgroup = true
```

## ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ä½œæˆï¼ˆãƒã‚¹ã‚¿ãƒ¼ï¼‰

```sh
sudo kubeadm init --pod-network-cidr=10.1.0.0/16

mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

kubectl get pods --all-namespaces
```

## ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã« Joinï¼ˆãƒ¯ãƒ¼ã‚«ãƒ¼ï¼‰

```sh
sudo kubeadm join 192.168.0.10:6443 --token <ãƒˆãƒ¼ã‚¯ãƒ³> --discovery-token-ca-cert-hash sha256:<ãƒãƒƒã‚·ãƒ¥å€¤>
```

## calico ã®æœ‰åŠ¹åŒ–

```sh
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/tigera-operator.yaml
curl https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/custom-resources.yaml -O

Change -> cidr: 10.1.0.0/16

kubectl create -f custom-resources.yaml
watch kubectl get pods -n calico-system
```

## æœ€çµ‚ç¢ºèª

```sh
kubectl get nodes

NAME           STATUS   ROLES           AGE   VERSION
k8s-master-1   Ready    control-plane   17m   v1.30.2
k8s-worker-1   Ready    <none>          11m   v1.30.2
```

# ãã®ä»–

### ã‚³ãƒ³ãƒ†ãƒŠãƒªãƒã‚¸ãƒˆãƒªã¯ GitHub ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚’åˆ©ç”¨

- ãŠã†ã¡ k8s ã¨ã„ã†ã“ã¨ã‚‚ã‚ã‚Š Harbor ã‚’ä½¿ã£ã¦è‡ªå®…ã«æ§‹ç¯‰ã—ãŸã‹ã£ãŸãŒã€[ARM ã«å¯¾å¿œã—ã¦ã„ãªã‹ã£ãŸ](https://github.com/goharbor/harbor-arm/issues/31)ã®ã§ GitHub ã‚’åˆ©ç”¨

### CD ã¯ ArgoCDï¼ˆImage Updaterï¼‰ã‚’ä½¿ã£ã¦è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

- Helm ã‹ Kustomize ã‚’åˆ©ç”¨ã—ã¦ãªã„ã¨å‹•ã‹ãªã„ã“ã¨ã«æ°—ãŒã¤ã‹ãšã«ãƒãƒã£ãŸ

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¯ Longhorn ã‚’ä½¿ã£ã¦ä¿å­˜å ´æ‰€ã‚’æ„è­˜ã—ãªã„ã§è‰¯ã„ã‚ˆã†ã«

- [ãŠã†ã¡ kubernetes å‘ã‘ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ã—ã¦ Longhorn ã‚’æ¡ç”¨ã—ã¦ã¿ãŸçµŒç·¯ã¨æ„Ÿæƒ³](https://light-of-moe.ddo.jp/~sakura/diary/?p=1575)

### ãƒ­ã‚°ç®¡ç†ã¯ Grafana ã¨ loki ã‚’åˆ©ç”¨

- FluentBit ã‚’åˆ©ç”¨ã—ã‚ˆã†ã¨ã—ãŸãŒã€[ãƒ©ã‚ºãƒ‘ã‚¤ 5 ã®ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚º 16KB ã ã¨å‹•ã‹ãªã‹ã£ãŸ](https://github.com/fluent/fluent-bit/issues/5778)ã®ã§ loki ã‚’åˆ©ç”¨
